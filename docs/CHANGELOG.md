# Changelog

All notable changes to this project will be documented in this file.

The format is based on Keep a Changelog and this project adheres to Semantic Versioning.

## [Unreleased]

- Added LICENSE (MIT) and README.md for public release.
- Updated `package.json` metadata: set `version` to `0.1.0`, added `author`, `repository`, `homepage`, `bugs`, `keywords`, `private: true`; changed `license` to `MIT`; removed unused `main` field.
- Added `.vscode/mcp.json` to `.gitignore`.
- Removed unused `copilot-setup-steps.yml` workflow.
- Narrowed supported languages to English and Japanese only (`['en', 'ja']`); removed Spanish (`'es'`) from `expectedInputs`, `LanguageModelExpectedIO` type, and `outputLanguage` type.
- Added `vitest.config.ts` to scope Vitest to `tests/unit/**/*.test.ts` only, preventing Vitest from loading Playwright E2E spec files.
- Added full E2E test coverage for AC-2 through AC-13: ai-availability (5 tests), ime-composition (2), keyboard-behavior (5), unsupported-inputs (7), skip-conditions (5), accessibility (2), cancellation (5), cooldown (3), tooltip (3). Total: 43 Playwright E2E tests passing across 11 spec files.
- Added Playwright E2E test infrastructure: `playwright.config.ts`, custom extension fixture (`tests/e2e/helpers/extension-fixture.ts`) that launches persistent Chromium with the sideloaded extension, configurable LanguageModel mock (`tests/e2e/helpers/mock-language-model.ts`) with timing/selector constants, seed test, and AC-1 suggestion flow tests. Added `test:e2e`, `test:e2e:ui`, `test:e2e:headed` npm scripts.
- Added comprehensive test site (`tests/e2e/fixtures/test-site.html`) covering all functional requirements (FR-1–FR-10) and acceptance criteria (AC-1–AC-13). Includes 9 sections: basic suggestion flow (incl. AI unavailability/failure per AC-2, FR-3, FR-7), unsupported input types, skip conditions (incl. AC-8 settings-persistence checklist), keyboard behavior, cancellation & cooldown (incl. caret-move cancellation per AC-10), overlay & tooltip, IME composition, edge cases (RTL, scroll, resize, Shadow DOM, long text, cursor-middle, custom styles), and dynamic elements. Fixed URL-only skip wording to match default preferences; replaced non-English fixture strings with English equivalents; marked Shadow DOM and dynamic-element cases as exploratory. All elements carry `data-testid` attributes for future Playwright E2E tests.
- Updated docs (ADR 0004, workflow-tdd, wxt-development-guidelines) to reference the E2E test fixture page and describe manual testing workflow.
- Renamed extension from "Emoji Completion" to "Emoji Whisper"; updated package name to `emoji-whisper`, manifest display name, and all documentation references.
- Removed unused `storage` and `activeTab` permissions from manifest (minimal-permission principle). Will re-add `storage` when persistent settings are implemented.
- Redesigned extension icon (icon.svg): larger face + cursor + sparkles on transparent background with glow filters and ghost-fade mask; lavender (#D4C8FF) sparkles/cursor for light-background visibility.
- Added gradient-background icon variant (icon-background.svg) for use in marketing and documentation.
- Synced `docs/architecture/repository-structure.md` with actual filesystem: added missing spec/dev/proposal docs, icon SVGs, root config files; removed phantom directories (modules/, public/, components/, composables/, hooks/, utils/, options/).
- Slimmed system rules from 12 lines to 6: removed category nouns ("object, animal, food, activity, place") and generic terms ("sentiment/mood", "metaphorical match") that SLMs attended to and hallucinated into output. Merged proximity, cursor, and anti-hallucination guidance into fewer, more direct instructions.
- Refactored prompt assembly to inject only the few-shot section matching the detected cursor position (beginning / end / mid-text), reducing per-inference example tokens from ~530 (all 17 examples) to ~40–160 (2–5 examples). Character mode injects short-input examples only.
- Added anti-hallucination rule: "In 'reason', ONLY cite words that actually appear in the provided Text. Never reference words from the examples."
- Extracted few-shot examples into module-private constants (`EXAMPLES_SHORT`, `EXAMPLES_END_OF_TEXT`, `EXAMPLES_BEGINNING_OF_TEXT`, `EXAMPLES_MID_TEXT`); `systemPromptTemplate` now contains rules only.
- Added proximity emphasis: new system rule instructing the model that words immediately adjacent to [CURSOR] are the strongest clues. Updated all few-shot reason formats to "Immediately before/after" wording, and enhanced sentence-mode suffix to "Focus on the words immediately adjacent to [CURSOR] first".
- Added 5 beginning-of-text `[CURSOR]` few-shot examples (cat, flowers, rain, soccer, airplane) teaching the model to rely on words after cursor when nothing precedes it.
- Reduced end-of-text `[CURSOR]` examples from 10 to 5 (guitar, debugging, overwhelmed, birthday, home) to match other sections and reduce prompt token count.
- Narrowed default sentence context to cursor sentence only: `beforeSentenceCount` 2→0, `afterSentenceCount` 1→0. The partial sentence containing the cursor is always included; additional sentences are no longer sent by default, reducing SLM drift toward overall text sentiment. Settings fields and validation (0–10 range) retained for future user-settings exposure.
- Lowered default `temperature` from 0.6 to 0.4 and `topK` from 8 to 5 for tighter, more position-focused inference with the narrower context window.
- Improved cursor-position awareness: added 2 new system prompt rules instructing the model to analyze context before AND after [CURSOR] and to mention surrounding context in its reasoning.
- Added 5 mid-text [CURSOR] few-shot examples (market, dog, music, book, campfire) to teach the model position-sensitive emoji selection.
- Added `[CURSOR]` marker to all end-of-text few-shot examples so they match actual sentence-mode input format; unified reason format to "Before cursor: ..." for consistency with mid-text examples.
- Separated short-input examples (without cursor) into their own "Examples (short input without cursor)" section for character-mode prompts.
- Reorganised few-shot examples into "end-of-text" and "mid-text with [CURSOR]" sections for clarity.
- Lowered default `temperature` from 0.7 to 0.6 for more deterministic, context-accurate suggestions.
- Strengthened sentence-mode user suffix to instruct the model to "Analyze the words before and after [CURSOR] carefully".
- Expanded `expectedInputs.languages` in Prompt API adapter from `['en']` to `['en', 'ja']` to improve multilingual input handling.
- Added ADR 0011: Cursor-position-aware prompt tuning.

- Added ADR 0010: Inline Mirror Overlay — replace absolute-positioned ghost div with a mirror overlay that renders the emoji inline with text flow, preventing overlay from covering existing text.
- Added domain value objects `MirrorContent` and `MirrorLayout` in `src/core/domain/overlay/` for pure, testable overlay geometry and text decomposition.
- Refactored `GhostOverlay` to use inline mirror overlay: creates a transparent mirror div over the target, renders text with ghost emoji inline at the caret, hides native text via `color: transparent` + `caretColor` preservation.
- Removed `getCaretPosition` dependency from overlay (retained in codebase for `ToastMessage`).
- Replaced CSS classes `.ec-ghost` → `.ec-mirror` + `.ec-mirror-ghost`; reduced ghost opacity from 0.80 to 0.50.
- Added scroll sync (target scroll listener) and `ResizeObserver` for textarea resize tracking.
- Rewrote `overlay.test.ts` with mirror-based assertions; added `mirror-content.test.ts` for domain pure-function tests.
- Fixed mirror text color: mirror now uses the original computed color captured before the `transparent` override, ensuring correct rendering on dark-themed pages and on repeated `show()` calls to the same target.
- Added tests for repeated `show()` on same target (color preservation) and `hide()` on DOM-detached target (graceful cleanup).
- Removed `caret.ts` and `caret.test.ts`: dead code with zero production imports; `ToastMessage` uses `getBoundingClientRect()` directly.
- Removed `MirrorLayout` value object (YAGNI): geometry in `positionMirror()` is trivial and doesn't warrant a domain type.
- Added ResizeObserver integration tests: `observe()` on show, callback triggers repositioning, `disconnect()` on hide, observer swap on target switch.
- Updated glossary: revised Overlay definition, added Mirror Overlay, Ghost Span, MirrorContent entries.
- Updated content-script README with file table, mirror overlay lifecycle, and key invariants.
- Added ADR-0010 addendum documenting `caret.ts` and `MirrorLayout` removal.

- Eliminated duplicated `DEFAULT_SETTINGS` / `DEFAULT_SKIP` in controller.ts by importing from `DEFAULT_USER_PREFERENCES` in core domain.
- Extracted presentation-layer constants in overlay.ts: CSS class names (`CSS`), ARIA attributes (`ARIA`), layout tuning knobs (`LAYOUT`), and `DEFAULT_TOAST_DURATION_MS`. Exported `CSS` for use by controller.ts.
- Adopted `responseConstraint` (Chrome 137+ structured output) on `session.prompt()` to enforce JSON output via JSON Schema instead of prompt-level instructions.
- Simplified system prompt: removed JSON format instructions ("Output MUST be valid JSON", "respond with valid JSON") since `responseConstraint` handles format enforcement. Content quality guidance (emoji selection rules, reason constraints, few-shot examples) retained.
- Removed "Return valid JSON" trailing instruction from `buildEmojiPrompt()`.
- Updated ADR 0009 with `responseConstraint` adoption update.
- Updated functional requirements (FR-4) with structured output specification.

- Added Chain-of-Thought (CoT) prompting: model now returns JSON `{ "reason": "...", "emoji": "..." }` instead of a bare emoji, enabling reasoning before selection.
- Added reason tooltip: hovering over the ghost emoji overlay shows the model's reasoning in a tooltip (AC-13).
- Added `SuggestionResult` value object holding both `emoji` and `reason` fields.
- Updated prompt template to JSON output format with explicit rules and 12 JSON few-shot examples.
- Updated `maxTokens` from 10 to 64 to accommodate JSON output with reason.
- Updated parser with JSON-first strategy and bare-emoji fallback for backward compatibility.
- Updated `SuggestionGenerator` port, `PromptAPIAdapter`, `SuggestionSession`, usecase, and controller to propagate `SuggestionResult` through all layers.
- Changed ghost overlay `pointer-events` from `none` to `auto` (with `mousedown` focus-steal prevention) to enable hover tooltip.
- Added ADR 0009: Chain-of-Thought prompting with reason output.
- Updated functional requirements (FR-4, FR-5), glossary, and acceptance criteria (AC-13).

- Added `topK` field to `PromptConfig` (default: 8) to control token sampling diversity; previously hardcoded to 3 in the Prompt API adapter.
- Expanded system prompt few-shot examples from 4 to 12 across 5 categories (single words, tech terms, abstract emotions, greetings/idioms, and no-direct-emoji concepts) with guidance for short-phrase inputs and metaphorical matching.
- Updated user-facing prompt suffix to say "best represents the text" / "Prefer a specific emoji over a generic sentiment emoji" for both character and sentence modes.
- Updated functional requirements to document `topK` and `temperature` as future user-configurable settings, and added AI model tuning section to the settings page specification.
- Updated glossary with `topK` definition.
- Added ADR 0008: Prompt and sampling tuning for emoji diversity.
- Fixed ghost overlay positioning on scrolled pages by converting viewport-relative caret coordinates to page-absolute coordinates (`+ window.scrollX/Y`).
- Pinned mirror div position in caret calculation to avoid layout-dependent measurement errors.
- Improved overlay visibility: increased opacity from 0.55 to 0.80 and removed incorrect `font: inherit` (was inheriting from `<body>` instead of the target input).
- Overlay now dynamically copies `fontSize` and `lineHeight` from the target input element for correct emoji scale.
- Added scroll and resize event listeners to reposition the overlay when the viewport changes (rAF-throttled).
- Added fallback positioning (bottom-right of input) when caret coordinates cannot be computed.
- Fixed ToastMessage positioning to account for page scroll offset.
- Added unit tests for caret positioning (`caret.test.ts`) and overlay behaviour (`overlay.test.ts`).

- Refactor: Moved skip rules (`SkipConditions`, `shouldSkipByLength`, `shouldSkipByConditions`) into `src/core/domain/suggestion/suggestion-skip-policy.ts` and re-exported them via `src/core/services/context.ts`.
- Fixed unit test import ordering in `context-service.test.ts` to avoid mid-file imports.
- Added ADR 0007: Bidirectional sentence-based context extraction, superseding ADR 0005. Introduces `contextMode`, `beforeSentenceCount`, `afterSentenceCount`, and `cursorMarker` settings for extracting context on both sides of the cursor.
- Updated glossary with new context extraction terms (ContextMode, beforeSentenceCount, afterSentenceCount, cursorMarker).
- Updated functional requirements to document sentence-mode context extraction settings.
- Implemented bidirectional sentence-based context extraction:
  - Added `ContextMode`, `SentenceContextSettings`, and unified `extractContext` function in `context.ts`.
  - Added `extractContextAroundCursor` for sentence-mode extraction with cursor marker.
  - Updated `buildEmojiPrompt` to support sentence-mode prompts with cursor marker instructions.
  - Updated orchestrator to use unified extraction and pass `isSentenceMode` to prompt builder.
  - Extended `UserPreferences` with `contextMode` and `sentenceContext` settings.
  - Added validation for sentence context settings (beforeSentenceCount, afterSentenceCount, cursorMarker).
  - Changed default `contextMode` to `'sentences'` for improved mid-text suggestions.
- Added comprehensive unit tests for sentence-based context extraction and validation.
- Refactor: Moved context extraction rules to `src/core/domain/context/context-extraction.ts` and extracted djb2 hashing into `src/core/shared/hash/djb2.ts`; kept `src/core/services/context.ts` as a backward-compatible facade.
- Moved core log primitives to `src/core/shared/log/` and updated all imports; kept `src/core/domain/log/*` as temporary compatibility re-exports during migration.
- Expanded keyboard domain (`src/core/domain/keyboard/key-utils.ts`) with `hasModifiers`, `isTabKey`, `isEscapeKey`, `isEnterKey` for consistent key event handling across the codebase.
- Split controller-helpers into responsibility-focused modules following DDD:
  - Moved `isPlainTabKey` to `src/core/domain/keyboard/key-utils.ts` (pure keyboard logic).
  - Moved throttle logic to `src/core/services/throttle.ts` (pure time-based logic).
  - Created `src/extension/content-script/dom-utils.ts` for DOM element utilities.
  - Created `src/extension/content-script/input-snapshot.ts` for DOM→snapshot conversion.
  - Split unit tests accordingly (`key-utils.test.ts`, `throttle.test.ts`).
- Refactored suggestion flow logic into a core application service (`beginEmojiSuggestionRequest` / `applyEmojiSuggestionResult`) to keep the content controller thinner and more changeable.
- Fixed keyboard interception rules: accept only plain `Tab` (never `Shift+Tab` or modified Tab), and never intercept keys during IME composition.
- Improved cancellation correctness: selection/caret movement now aborts pending Prompt API requests (not just hides the overlay).
- Throttled AI-unavailable toast messages to avoid repeated notifications while the user keeps typing.
- Added unit tests for controller helper logic (Tab interception + toast throttling).
- **Fixed Prompt API access**: Changed content script to run in main world (`world: 'MAIN'`) so `globalThis.LanguageModel` is accessible.
- **Fixed session state bug**: Moved `cancelPendingOnly()` before `beginRequest()` to prevent immediately cancelling the newly started request.
- **Updated Prompt API bindings**: Standardized on the Chrome 138+ `globalThis.LanguageModel` global (static methods) and removed legacy `ai.languageModel` fallbacks.
- Passed `outputLanguage` into LanguageModel API calls to avoid browser warnings and improve output quality/safety attestation.
- Improved content-script diagnostics by logging the specific guard/skip reason when a suggestion attempt doesn't trigger.
- Added comprehensive debug logging for overlay show/hide/reposition and toast messages.
- Added log level prefix (`[DEBUG]`, `[INFO ]`, etc.) to console output for easier filtering.
- Added `contextLength` to AI generation logs for input/output visibility.
- Expanded context extraction tests to document the specification (cursor position, maxContextLength, boundary adjustment, skip conditions).
- Updated glossary with detailed definitions for Context, Sentence Boundary, and Settings terms.
- Removed unused Prompt API adapter exports and refreshed docs/glossary to match the official `globalThis.LanguageModel` entrypoint.
- Added `'downloadable'` to `AvailabilityState` type to match Chrome's actual API return values.
- Changed `pnpm dev` to run a dev-mode build without launching the browser runner; kept runner behavior under `pnpm dev:runner`.
- Added a VS Code Chrome attach debug configuration and documented content-script debugging with WXT inline sourcemaps.
- Fixed VS Code TS breakpoint binding for content scripts by adjusting Chrome attach sourcemap resolution/path overrides.
- Enabled inline sourcemaps for dev builds in WXT config and updated VS Code launch to auto-load the unpacked dev build.
- Improved Prompt API reliability by passing matching `expectedInputs`/`expectedOutputs` options into both `LanguageModel.availability()` and `LanguageModel.create()`.
- Added a VS Code task for `pnpm lint` for consistent local verification.
- Improved diagnostics: logger defaults to debug in dev builds even when `import.meta.env` is missing; added info-level first-activation log and differentiated AI unavailability messages.
- Enforced the logging boundary by disallowing `console.*` usage outside the console log sink via ESLint.
- Documented that [web-ext.config.ts](../web-ext.config.ts) is developer-local runner configuration and must not be modified/committed as part of feature work.
- Added a unified logging system (core Log domain objects + extension console sink) and instrumented content script runtime for easier debugging.
- Fixed content script startup crash by removing an unsupported `browser.runtime.getPlatformInfo()` call.
- Added unit tests for context extraction, prompt building, orchestrator preparation, and user preferences validation.
- Added Clock injection in the content-script controller for time-based testability.
- Improved ghost overlay accessibility with polite ARIA announcements for suggestions.
- Added initial WXT implementation scaffolding (content script entrypoint, caret overlay UI, and Prompt API adapter).
- Added WXT/TypeScript project wiring (`wxt.config.ts`, `tsconfig.json`, and package scripts).
- Added Web Standards compliance guidance to non-functional requirements.
- Added WXT development guidelines under docs/dev for WXT-specific structure and constraints.
- Added glossary and DDD-based domain model ADR for consistent terminology and design.
- Added authoritative repository structure ASCII tree and required using it for future file operations.
- Updated the repository structure to align with WXT project conventions when `srcDir: 'src'` is enabled.
- Expanded functional requirements with prompt specification, context extraction rules, skip rules, lifecycle cancellation, and message UX details.
- Cleaned up duplicated content in functional requirements.
- Updated suggestion triggering to Copilot-style idle/Enter ghost suggestions (Tab accepts; Esc dismisses) with cooldown, selection/IME suppression, and immediate cancellation on interaction.
- Updated defaults and terminology: `minContextLength` default to 5, and renamed “trigger key” to “accept key” in docs/ADRs.
- Added prompt configuration domain object and fixed system prompt guidance for MVP.
- Updated specs to include Microsoft Edge (Chromium) support alongside Chrome.
- Updated overview to reflect Chrome/Edge support and Prompt API wording.
- Expanded acceptance criteria to cover skip conditions, settings persistence, accessibility announcements, and cancellation on input change.
- Added overlay positioning and accessibility announcements to non-functional requirements.
- Added English-only and changelog maintenance rules to AI coding guidelines.
- Added a repository-level Copilot instructions file to enforce spec/ADR/dev doc usage.
- Added project changelog under docs.
- Added core domain objects (Context, Suggestion, SuggestionSession) and core ports (AvailabilityChecker, SuggestionGenerator) aligned with ADR 0006.
- Added emoji suggestion preparation service in core and refactored content-script controller to use domain session/state instead of ad-hoc local state.
- Added Vitest unit tests for suggestion parsing and session invariants, plus `test` scripts.
- Updated dev docs to document `pnpm test:run`/`pnpm typecheck` and added commenting guidelines for domain and ports.
- Added VS Code launch.json and tasks.json for Vitest debugging and WXT dev/build tasks.
- Fixed `pnpm dev`/VS Code DEV task to run `wxt` correctly (WXT treats the first positional argument as the project root).
- Added ESLint TypeScript linter setup (flat config) and a dedicated `tsconfig.eslint.json` (for optional typed linting later).
- Updated AI/dev workflow docs to require `pnpm lint` + `pnpm typecheck` after agent-driven code changes.
